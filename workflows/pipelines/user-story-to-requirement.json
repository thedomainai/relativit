{
  "name": "user-story-to-requirement",
  "version": "1.0.0",
  "description": "Automated pipeline to transform user stories into structured requirements",
  "trigger": {
    "type": "file_creation",
    "watch_path": "requirements/raw/user-stories/",
    "patterns": ["*.json", "*.txt", "*.md"]
  },
  "stages": [
    {
      "id": "parse",
      "name": "Parse User Story",
      "type": "parsing",
      "parser": "user_story_parser",
      "inputs": ["user_story_file"],
      "outputs": ["parsed_story"],
      "config": {
        "detect_format": true,
        "convert_to_json": true
      }
    },
    {
      "id": "validate",
      "name": "Validate User Story",
      "type": "validation",
      "validator": "user_story_validator",
      "inputs": ["parsed_story"],
      "outputs": ["validation_result"],
      "schema": "templates/user-story.schema.json",
      "rules": [
        "has_as_a_i_want_so_that",
        "has_acceptance_criteria",
        "has_clear_value"
      ]
    },
    {
      "id": "enrich",
      "name": "Enrich User Story",
      "type": "ai_task",
      "agent": "story_enricher",
      "inputs": ["parsed_story", "validation_result"],
      "outputs": ["enriched_story"],
      "config": {
        "add_missing_acceptance_criteria": true,
        "suggest_edge_cases": true,
        "estimate_story_points": true,
        "generate_id": true
      }
    },
    {
      "id": "extract_personas",
      "name": "Extract Personas",
      "type": "ai_task",
      "agent": "persona_extractor",
      "inputs": ["enriched_story"],
      "outputs": ["personas"],
      "config": {
        "match_existing_personas": true,
        "create_new_if_needed": true,
        "destination": "knowledge/domain/personas.json"
      }
    },
    {
      "id": "generate_requirements",
      "name": "Generate Requirements",
      "type": "ai_task",
      "agent": "requirement_generator",
      "inputs": ["enriched_story", "personas"],
      "outputs": ["requirements"],
      "config": {
        "prompt_template": ".agent/prompts/task/process_user_story.md",
        "generate_functional": true,
        "generate_non_functional": true,
        "extract_constraints": true
      }
    },
    {
      "id": "identify_workflows",
      "name": "Identify Workflows",
      "type": "ai_task",
      "agent": "workflow_extractor",
      "inputs": ["enriched_story"],
      "outputs": ["workflows"],
      "config": {
        "map_user_journey": true,
        "identify_touchpoints": true,
        "destination": "knowledge/domain/workflows.json"
      }
    },
    {
      "id": "analyze_dependencies",
      "name": "Analyze Dependencies",
      "type": "analysis",
      "analyzer": "dependency_analyzer",
      "inputs": ["enriched_story", "existing_stories"],
      "outputs": ["dependencies"],
      "config": {
        "detect_blocks": true,
        "detect_blocked_by": true,
        "detect_related": true,
        "update_dependency_graph": true
      }
    },
    {
      "id": "generate_test_scenarios",
      "name": "Generate Test Scenarios",
      "type": "ai_task",
      "agent": "test_scenario_generator",
      "inputs": ["enriched_story", "requirements"],
      "outputs": ["test_scenarios"],
      "config": {
        "include_positive_cases": true,
        "include_negative_cases": true,
        "include_edge_cases": true,
        "format": "given_when_then"
      }
    },
    {
      "id": "quality_check",
      "name": "Quality Check",
      "type": "decision",
      "condition": "validation_result.score >= 0.8 && requirements.length > 0",
      "on_success": "save",
      "on_failure": "flag_for_review"
    },
    {
      "id": "flag_for_review",
      "name": "Flag for Human Review",
      "type": "notification",
      "action": "create_review_request",
      "inputs": ["enriched_story", "validation_result", "issues"],
      "config": {
        "reason": "quality_threshold_not_met",
        "details": "validation_result.issues"
      }
    },
    {
      "id": "save",
      "name": "Save Processed Story",
      "type": "storage",
      "action": "save_multiple",
      "destinations": [
        {
          "path": "requirements/processed/user-stories/",
          "content": "enriched_story",
          "format": "json"
        },
        {
          "path": "requirements/processed/functional/",
          "content": "requirements.functional",
          "format": "json",
          "multiple_files": true
        },
        {
          "path": "requirements/processed/non-functional/",
          "content": "requirements.non_functional",
          "format": "json",
          "multiple_files": true
        }
      ]
    },
    {
      "id": "trigger_next_pipeline",
      "name": "Trigger Specification Pipeline",
      "type": "event",
      "action": "emit",
      "event_name": "requirement.approved",
      "payload": {
        "requirement_ids": "requirements.*.id",
        "source_story": "enriched_story.id"
      }
    },
    {
      "id": "update_state",
      "name": "Update Project State",
      "type": "state_update",
      "updates": [
        {
          "path": ".state/current/project-state.json",
          "field": "components.requirements.count",
          "operation": "increment"
        },
        {
          "path": ".state/current/project-state.json",
          "field": "components.requirements.last_updated",
          "value": "{{timestamp}}"
        }
      ]
    }
  ],
  "error_handling": {
    "retry_attempts": 2,
    "fallback": "save_partial_results_and_notify",
    "preserve_original": true
  },
  "monitoring": {
    "metrics": [
      "processing_time",
      "requirements_generated_count",
      "validation_score",
      "confidence_score"
    ],
    "log_level": "detailed"
  },
  "learning": {
    "record_patterns": true,
    "feedback_collection": true,
    "improvement_tracking": true
  }
}
